<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal</title>
<style>
  :root{
    --bg:#05040a;
    --card:#0b0f1a;
    --muted:#9fb8ff;
    --neon1:#7c4dff; /* violet */
    --neon2:#00c2ff; /* cyan */
    --accent:#8a6bff;
    --glass: rgba(255,255,255,0.03);
    --txt:#e9f2ff;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:
    radial-gradient(600px 200px at 10% 10%, rgba(124,77,255,0.06), transparent 10%),
    linear-gradient(180deg,#03020a 0%, #071025 60%, #040412 100%); color:var(--txt); font-family:Inter,Segoe UI,Arial,sans-serif;}
  .wrap{max-width:980px;margin:28px auto;padding:18px;}
  header{display:flex;align-items:center;justify-content:space-between;}
  .brand{display:flex;flex-direction:column;}
  h1{margin:0;font-size:1.25rem;color:var(--neon2);letter-spacing:0.6px;}
  .subtitle{color:var(--muted);font-size:0.88rem;margin-top:4px;}

  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03); box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .row{display:flex;gap:10px;align-items:center}
  input[type="text"], input[type="password"], input[type="number"], input[type="date"], select{
    width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03);
    background:#071023; color:var(--txt); outline:none; font-size:1rem;
  }
  button{border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800;color:#031028;background:linear-gradient(90deg,var(--neon2),var(--neon1));box-shadow:0 12px 30px rgba(124,77,255,0.06);transition:transform .12s,box-shadow .12s}
  button:hover{transform:translateY(-3px); box-shadow:0 20px 50px rgba(124,77,255,0.12)}
  .secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:700}
  .section{display:none;margin-top:14px}
  .show{display:block}
  .profile{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#08102a;border-radius:10px;margin-bottom:12px;border:1px solid rgba(0,194,255,0.04)}
  .links{display:flex;gap:8px;align-items:center}
  .small{font-size:0.88rem;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.95rem}
  th{background:linear-gradient(90deg,var(--neon2),var(--neon1));color:#041022;font-weight:800}
  .status{display:inline-block;padding:6px 8px;border-radius:8px;font-weight:700}
  .status.active{background:rgba(0,194,255,0.08);color:var(--neon2)}
  .status.inactive{background:rgba(255,255,255,0.02);color:var(--muted)}
  .withdraw-status{padding:4px 8px;border-radius:6px;font-weight:700;color:#111;display:inline-block}
  .processing{background:#ffd54d}
  .paid{background:#7cffb2}
  .transactions{max-height:300px;overflow:auto;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
  footer{margin-top:18px;color:var(--muted);font-size:0.9rem}
  @media(max-width:820px){header{flex-direction:column;align-items:flex-start} .row{flex-direction:column}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Portal</h1>
        <div class="subtitle">Play — Earn — Withdraw</div>
      </div>
      <div class="small">Blue-Violet Cyberpunk • Local mode</div>
    </header>

    <!-- LOGIN PAGE -->
    <div id="loginPage" class="card section show">
      <h2 style="margin:0 0 10px 0;color:var(--neon1)">Access</h2>
      <div class="row">
        <div style="flex:1">
          <div class="small">Username</div>
          <input id="loginUser" type="text" placeholder="username">
        </div>
        <div style="width:240px">
          <div class="small">Password</div>
          <input id="loginPass" type="password" placeholder="password">
        </div>
        <div style="width:120px">
          <div style="height:28px"></div>
          <button id="loginBtn">Login</button>
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;">
        <button id="gotoRegister" class="secondary">Register</button>
        <button id="gotoForgot" class="secondary">Forgot Password</button>
      </div>
      <div style="margin-top:10px" class="small">New accounts must be activated by admin before they can play or withdraw.</div>
    </div>

    <!-- REGISTER PAGE -->
    <div id="registerPage" class="card section">
      <h2 style="margin:0 0 10px 0;color:var(--neon1)">Create account</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <div class="small">Username</div>
          <input id="regUser" type="text" placeholder="username">
        </div>
        <div>
          <div class="small">Birthdate</div>
          <input id="regBirth" type="date">
        </div>
        <div>
          <div class="small">Password</div>
          <input id="regPass" type="password" placeholder="password">
        </div>
        <div>
          <div class="small">Confirm password</div>
          <input id="regPass2" type="password" placeholder="confirm password">
        </div>
        <div style="grid-column:1/ -1">
          <div class="small">Security question</div>
          <select id="regQ">
            <option value="pet">First pet's name?</option>
            <option value="maiden">Mother's maiden name?</option>
            <option value="school">Elementary school?</option>
            <option value="hero">Favorite hero?</option>
          </select>
        </div>
        <div style="grid-column:1/ -1">
          <div class="small">Answer</div>
          <input id="regA" type="text" placeholder="answer">
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px;">
        <button id="registerBtn">Register</button>
        <button id="backToLoginFromReg" class="secondary">Back</button>
      </div>
      <div style="margin-top:8px" class="small">After register your account remains inactive until activated by admin.</div>
    </div>

    <!-- FORGOT PAGE -->
    <div id="forgotPage" class="card section">
      <h2 style="margin:0 0 10px 0;color:var(--neon1)">Reset password</h2>
      <div id="fpStep1">
        <div class="small">Username</div>
        <input id="fpUser" type="text" placeholder="username">
        <div class="small" style="margin-top:8px">Birthdate</div>
        <input id="fpBirth" type="date">
        <div style="margin-top:10px;display:flex;gap:8px;">
          <button id="fpFindBtn">Find</button>
          <button id="backToLoginFromFP" class="secondary">Back</button>
        </div>
      </div>

      <div id="fpStep2" style="display:none;margin-top:10px">
        <div class="small">Security question for <strong id="fpUserLabel"></strong>:</div>
        <div id="fpQuestion" style="font-weight:700;margin:8px 0"></div>
        <div class="small">Answer</div>
        <input id="fpAnswer" type="text">
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button id="fpCheckBtn">Check</button>
          <button id="fpCancel2" class="secondary">Cancel</button>
        </div>
      </div>

      <div id="fpStep3" style="display:none;margin-top:10px">
        <div class="small">Set new password for <strong id="fpUserLabel2"></strong></div>
        <input id="fpNewPass" type="password" placeholder="new password">
        <input id="fpNewPass2" type="password" placeholder="confirm new password" style="margin-top:8px">
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button id="fpSetBtn">Set Password</button>
          <button id="fpCancel3" class="secondary">Cancel</button>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashPage" class="card section">
      <div class="profile">
        <div>
          <div style="font-weight:800" id="profileName">Guest</div>
          <div class="small">Balance: <strong id="balance">0</strong>₱</div>
          <div class="small" id="accStatus" style="margin-top:4px"></div>
        </div>
        <div class="links">
          <button id="logoutBtn" class="secondary">Logout</button>
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:10px">
        <button id="playBtn">Play Game</button>
        <button id="goWithdraw">Withdraw</button>
        <button id="goTransactions">Transactions</button>
      </div>
      <div class="small">Note: Each correct answer gives +2₱. Maximum 5 questions per session.</div>
    </div>

    <!-- GAME -->
    <div id="gamePage" class="card section">
      <h2 style="margin:0 0 10px 0;color:var(--neon1)">Game</h2>
      <div class="small" id="gameCounter">Question 0 / 5</div>
      <div id="questionText" style="margin:12px 0;font-size:1.2rem;color:var(--neon2)"></div>
      <div>
        <div class="small">Your answer</div>
        <input id="answerInput" type="text">
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="submitAnswer">Submit</button>
        <button id="gameBack" class="secondary">Back</button>
      </div>
      <div style="margin-top:12px" class="small">Streak resets when you answer wrong.</div>
    </div>

    <!-- WITHDRAW -->
    <div id="withdrawPage" class="card section">
      <h2 style="margin:0 0 10px 0;color:var(--neon1)">Withdraw</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div>
          <div class="small">Method</div>
          <select id="wMethod">
            <option value="gcash">GCash</option>
            <option value="paymaya">PayMaya</option>
          </select>
        </div>
        <div>
          <div class="small">Number</div>
          <input id="wNumber" type="text" placeholder="09XXXXXXXXX">
        </div>
        <div style="grid-column:1/ -1">
          <div class="small">Amount (min ₱5)</div>
          <input id="wAmount" type="number" min="5" placeholder="5">
        </div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="requestW">Request Withdraw</button>
        <button id="withdrawBack" class="secondary">Back</button>
      </div>
      <div style="margin-top:12px">
        <div class="small">Your withdraw requests</div>
        <div id="myWithdraws" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- TRANSACTIONS -->
    <div id="transPage" class="card section">
      <h2 style="margin:0 0 10px 0;color:var(--neon1)">Transactions</h2>
      <div id="txList" class="transactions"></div>
      <div style="margin-top:10px"><button id="txBack" class="secondary">Back</button></div>
    </div>

    <footer class="small">Data is stored locally in your browser (localStorage). Admin monitor reads the same storage.</footer>
  </div>

<script>
/* client.html - fully functional client portal
   - storage keys: users (array), withdraws (array)
   - registration creates user with isActive:false (requires admin activation)
   - login checks isActive
   - game: 5 random questions per session (non-repeating), +2₱ per correct
   - withdraw: min 5, creates withdraw entry with status 'processing'
   - transactions stored per user in user.transactions array (objects)
*/

(function(){
  // elements
  const pages = {
    login: document.getElementById('loginPage'),
    register: document.getElementById('registerPage'),
    forgot: document.getElementById('forgotPage'),
    dash: document.getElementById('dashPage'),
    game: document.getElementById('gamePage'),
    withdraw: document.getElementById('withdrawPage'),
    trans: document.getElementById('transPage')
  };

  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const loginBtn = document.getElementById('loginBtn');
  const gotoRegister = document.getElementById('gotoRegister');
  const gotoForgot = document.getElementById('gotoForgot');

  const registerBtn = document.getElementById('registerBtn');
  const backToLoginFromReg = document.getElementById('backToLoginFromReg');

  const fpFindBtn = document.getElementById('fpFindBtn');
  const fpSetBtn = document.getElementById('fpSetBtn');
  const backToLoginFromFP = document.getElementById('backToLoginFromFP');
  const fpCancel2 = document.getElementById('fpCancel2');
  const fpCancel3 = document.getElementById('fpCancel3');

  const profileName = document.getElementById('profileName');
  const balanceEl = document.getElementById('balance');
  const accStatus = document.getElementById('accStatus');
  const logoutBtn = document.getElementById('logoutBtn');

  const playBtn = document.getElementById('playBtn');
  const goWithdraw = document.getElementById('goWithdraw');
  const goTransactions = document.getElementById('goTransactions');

  const questionText = document.getElementById('questionText');
  const answerInput = document.getElementById('answerInput');
  const submitAnswer = document.getElementById('submitAnswer');
  const gameCounter = document.getElementById('gameCounter');
  const gameBack = document.getElementById('gameBack');

  const wMethod = document.getElementById('wMethod');
  const wNumber = document.getElementById('wNumber');
  const wAmount = document.getElementById('wAmount');
  const requestW = document.getElementById('requestW');
  const withdrawBack = document.getElementById('withdrawBack');
  const myWithdraws = document.getElementById('myWithdraws');

  const txList = document.getElementById('txList');
  const txBack = document.getElementById('txBack');

  // register inputs
  const regUser = document.getElementById('regUser');
  const regPass = document.getElementById('regPass');
  const regPass2 = document.getElementById('regPass2');
  const regBirth = document.getElementById('regBirth');
  const regQ = document.getElementById('regQ');
  const regA = document.getElementById('regA');

  // forgot inputs
  const fpUser = document.getElementById('fpUser');
  const fpBirth = document.getElementById('fpBirth');
  const fpUserLabel = document.getElementById('fpUserLabel');
  const fpQuestion = document.getElementById('fpQuestion');
  const fpAnswer = document.getElementById('fpAnswer');
  const fpNewPass = document.getElementById('fpNewPass');
  const fpNewPass2 = document.getElementById('fpNewPass2');
  const fpStep1 = document.getElementById('fpStep1');
  const fpStep2 = document.getElementById('fpStep2');
  const fpStep3 = document.getElementById('fpStep3');
  const fpUserLabel2 = document.getElementById('fpUserLabel2');

  // data
  let users = JSON.parse(localStorage.getItem('users') || '[]'); // array of user objects
  let withdraws = JSON.parse(localStorage.getItem('withdraws') || '[]'); // array of withdraw objects
  let currentUser = null;

  // sample questions (can expand)
  const questions = [
    {q:'2 + 2', a:'4'},
    {q:'5 * 3', a:'15'},
    {q:'10 - 7', a:'3'},
    {q:'9 / 3', a:'3'},
    {q:'6 * 6', a:'36'},
    {q:'8 + 12', a:'20'},
    {q:'15 - 5', a:'10'},
    {q:"Who is the national hero of the Philippines?", a:'Rizal'},
    {q:'What is the tallest tree?', a:'Sequoia'},
    {q:'What is 12 - 8', a:'4'}
  ];

  // helper fns
  function saveAll(){
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('withdraws', JSON.stringify(withdraws));
  }
  function show(page){
    Object.values(pages).forEach(p => p.classList.remove('show'));
    pages[page].classList.add('show');
    window.scrollTo(0,0);
  }

  function findUserObj(username){
    return users.find(u => u.username === username);
  }

  function updateProfileUI(){
    if(currentUser){
      profileName.innerText = currentUser.username;
      balanceEl.innerText = currentUser.balance || 0;
      if(currentUser.isActive === false){
        accStatus.innerHTML = '<span style="color:#ffb86b">Account inactive — wait for activation</span>';
      } else {
        accStatus.innerHTML = '<span style="color:#7cf5ff">Account active</span>';
      }
    } else {
      profileName.innerText = 'Guest';
      balanceEl.innerText = '0';
      accStatus.innerText = '';
    }
  }

  // initialize default admin placeholder if none exists (keeps admin monitor consistent)
  (function ensureAdmin(){
    if(!users.some(u => u.isAdmin)){
      users.push({ username:'system', password:'hidden', balance:0, isAdmin:true, isActive:true, transactions:[] });
      saveAll();
    }
  })();

  // NAV: login -> register/forgot
  gotoRegister.addEventListener('click', ()=> show('register'));
  gotoForgot.addEventListener('click', ()=> show('forgot'));

  backToLoginFromReg.addEventListener('click', ()=> show('login'));
  backToLoginFromFP.addEventListener('click', ()=> {
    fpStep1.style.display='block'; fpStep2.style.display='none'; fpStep3.style.display='none';
    show('login');
  });

  // REGISTER
  registerBtn.addEventListener('click', ()=>{
    const u = (regUser.value || '').trim();
    const p = regPass.value || '';
    const p2 = regPass2.value || '';
    const b = regBirth.value || '';
    const q = regQ.value || '';
    const a = (regA.value || '').trim();
    if(!u || !p || !p2 || !b || !q || !a){ alert('Fill all fields'); return; }
    if(p !== p2){ alert('Passwords do not match'); return; }
    if(users.find(x => x.username.toLowerCase() === u.toLowerCase())){ alert('Username exists'); return; }
    // new accounts need admin activation
    const newUser = { username:u, password:p, balance:0, birth:b, question:q, answer:a, isAdmin:false, isActive:false, transactions:[] };
    users.push(newUser);
    saveAll();
    alert('Registered. Wait for admin to activate your account before logging in.');
    // clear fields
    regUser.value=''; regPass.value=''; regPass2.value=''; regBirth.value=''; regA.value='';
    show('login');
  });

  // LOGIN
  loginBtn.addEventListener('click', ()=>{
    const u = (loginUser.value || '').trim();
    const p = loginPass.value || '';
    const user = users.find(x => x.username.toLowerCase() === u.toLowerCase() && x.password === p);
    if(!user){ alert('Wrong credentials'); return; }
    if(!user.isAdmin && user.isActive === false){ alert('Account not activated'); return; }
    currentUser = user;
    // make sure transactions array exists
    currentUser.transactions = currentUser.transactions || [];
    updateProfileUI();
    show('dash');
    // clear login fields
    loginUser.value=''; loginPass.value='';
  });

  logoutBtn.addEventListener('click', ()=>{
    currentUser = null;
    updateProfileUI();
    show('login');
  });

  // FORGOT PASSWORD flow
  fpFindBtn.addEventListener('click', ()=>{
    const un = (fpUser.value || '').trim();
    const b = fpBirth.value || '';
    const user = users.find(x => x.username.toLowerCase() === un.toLowerCase() && x.birth === b);
    if(!user){ alert('No matching account'); return; }
    // show question
    fpUserLabel.innerText = user.username;
    fpQuestion.innerText = user.question;
    fpStep1.style.display = 'none';
    fpStep2.style.display = 'block';
    fpStep3.style.display = 'none';
  });

  document.getElementById('fpCheckBtn').addEventListener('click', ()=>{
    const un = (fpUser.value || '').trim();
    const ans = (fpAnswer.value || '').trim();
    const user = users.find(x => x.username.toLowerCase() === un.toLowerCase());
    if(!user){ alert('User not found'); return; }
    if(ans !== user.answer){ alert('Wrong answer'); return; }
    fpUserLabel2.innerText = user.username;
    fpStep2.style.display = 'none';
    fpStep3.style.display = 'block';
  });

  fpCancel2.addEventListener('click', ()=> { fpStep1.style.display='block'; fpStep2.style.display='none'; });
  fpCancel3.addEventListener('click', ()=> { fpStep1.style.display='block'; fpStep3.style.display='none'; });

  fpSetBtn.addEventListener('click', ()=>{
    const newp = fpNewPass.value || '';
    const newp2 = fpNewPass2.value || '';
    const un = (fpUser.value || '').trim();
    if(!newp || !newp2){ alert('Enter new password'); return; }
    if(newp !== newp2){ alert('Passwords do not match'); return; }
    const user = users.find(x => x.username.toLowerCase() === un.toLowerCase());
    if(!user){ alert('User not found'); return; }
    user.password = newp;
    saveAll();
    alert('Password updated. You can now log in.');
    // reset forgot form
    fpUser.value=''; fpBirth.value=''; fpAnswer.value=''; fpNewPass.value=''; fpNewPass2.value='';
    fpStep1.style.display='block'; fpStep2.style.display='none'; fpStep3.style.display='none';
    show('login');
  });

  // DASH actions
  playBtn.addEventListener('click', ()=> {
    if(!currentUser){ alert('Login first'); return; }
    if(currentUser.isActive === false){ alert('Account not activated.'); return; }
    startGameSession();
  });

  goWithdraw.addEventListener('click', ()=>{
    if(!currentUser){ alert('Login first'); return; }
    if(currentUser.isActive === false){ alert('Account not activated.'); return; }
    renderMyWithdraws();
    show('withdraw');
  });

  goTransactions.addEventListener('click', ()=>{
    if(!currentUser){ alert('Login first'); return; }
    renderTransactions();
    show('trans');
  });

  // GAME logic
  let gameSet = [];
  let gameIndex = 0;
  let streak = 0;
  function startGameSession(){
    // choose 5 random non-repeating questions
    const pool = questions.slice();
    const shuffled = [];
    while(pool.length && shuffled.length < 5){
      const idx = Math.floor(Math.random()*pool.length);
      shuffled.push(pool.splice(idx,1)[0]);
    }
    gameSet = shuffled;
    gameIndex = 0;
    streak = 0;
    showQuestion();
    show('game');
  }

  function showQuestion(){
    if(gameIndex >= gameSet.length){
      alert('Game session finished.');
      show('dash');
      return;
    }
    const q = gameSet[gameIndex];
    questionText.innerText = q.q;
    gameCounter.innerText = 'Question ' + (gameIndex+1) + ' / 5';
    answerInput.value = '';
    answerInput.focus();
  }

  submitAnswer.addEventListener('click', ()=>{
    if(!currentUser){ alert('Login first'); show('login'); return; }
    const ans = (answerInput.value || '').trim();
    if(!ans){ alert('Enter an answer'); return; }
    const correct = (ans.toLowerCase() === (gameSet[gameIndex].a || '').toLowerCase());
    if(correct){
      currentUser.balance = (currentUser.balance || 0) + 2;
      streak++;
      alert('Correct! +2₱');
      currentUser.transactions = currentUser.transactions || [];
      currentUser.transactions.push({ type:'Game', desc: gameSet[gameIndex].q, amount:2, ts: new Date().toISOString() });
    } else {
      streak = 0;
      alert('Wrong! Correct answer: ' + gameSet[gameIndex].a);
      currentUser.transactions = currentUser.transactions || [];
      currentUser.transactions.push({ type:'Game', desc: gameSet[gameIndex].q + ' (wrong)', amount:0, ts: new Date().toISOString() });
    }
    // save user to users array and persist
    const u = findUserObj(currentUser.username);
    if(u){
      u.balance = currentUser.balance;
      u.transactions = currentUser.transactions;
    }
    saveAll();
    updateProfileUI();
    gameIndex++;
    if(gameIndex < 5) showQuestion();
    else { alert('Round complete.'); show('dash'); }
  });

  gameBack.addEventListener('click', ()=> { show('dash'); });

  // WITHDRAW
  function renderMyWithdraws(){
    const mine = withdraws.filter(w => w.user === currentUser.username);
    let html = '';
    if(mine.length === 0) html = '<div class="small">No withdraws yet.</div>';
    else {
      html = '<table><thead><tr><th>Method</th><th>Number</th><th>Amount</th><th>Status</th></tr></thead><tbody>';
      mine.forEach(w => {
        html += `<tr><td>${(w.method||'').toUpperCase()}</td><td>${w.number||''}</td><td>${w.amount}₱</td><td><span class="status ${w.status === 'paid' ? 'active' : (w.status === 'approved' ? 'active' : '')}">${w.status||'processing'}</span></td></tr>`;
      });
      html += '</tbody></table>';
    }
    myWithdraws.innerHTML = html;
  }

  requestW.addEventListener('click', ()=>{
    if(!currentUser){ alert('Login first'); return; }
    const method = wMethod.value;
    const number = (wNumber.value || '').trim();
    const amount = parseInt(wAmount.value);
    if(!number || isNaN(amount) || amount < 5){ alert('Enter valid number and amount (>=5)'); return; }
    if(amount > (currentUser.balance || 0)){ alert('Not enough balance'); return; }
    // Deduct immediately (admin will mark paid separately)
    currentUser.balance -= amount;
    currentUser.transactions = currentUser.transactions || [];
    currentUser.transactions.push({ type:'Withdraw Request', desc: `${method.toUpperCase()} ${number}`, amount:-amount, ts: new Date().toISOString() });
    // push withdraw
    withdraws.push({ user: currentUser.username, method, number, amount, status: 'processing', ts: new Date().toISOString() });
    // persist
    const u = findUserObj(currentUser.username);
    if(u){
      u.balance = currentUser.balance;
      u.transactions = currentUser.transactions;
    }
    saveAll();
    updateProfileUI();
    renderMyWithdraws();
    alert('Withdraw requested. Wait for admin to approve/mark paid.');
    // clear fields
    wNumber.value=''; wAmount.value='';
  });

  withdrawBack.addEventListener('click', ()=> show('dash'));

  // TRANSACTIONS
  function renderTransactions(){
    if(!currentUser){ txList.innerHTML = '<div class="small">Login first</div>'; return; }
    const txs = currentUser.transactions || [];
    if(!txs.length){ txList.innerHTML = '<div class="small">No transactions yet</div>'; return; }
    let html = '';
    html += '<table style="width:100%"><thead><tr><th>Type</th><th>Description</th><th>Amount</th><th>When</th></tr></thead><tbody>';
    txs.slice().reverse().forEach(t => {
      const when = t.ts ? new Date(t.ts).toLocaleString() : '';
      const amt = (typeof t.amount === 'number') ? (t.amount>0 ? '+'+t.amount+'₱' : t.amount+'₱') : '';
      html += `<tr><td>${t.type||''}</td><td>${t.desc||''}</td><td>${amt}</td><td style="font-size:0.85rem;color:var(--muted)">${when}</td></tr>`;
    });
    html += '</tbody></table>';
    txList.innerHTML = html;
  }

  txBack.addEventListener('click', ()=> show('dash'));

  // utility: keep users list in sync with currentUser reference if mutated externally
  window.addEventListener('storage', function(e){
    if(e.key === 'users' || e.key === 'withdraws'){
      users = JSON.parse(localStorage.getItem('users') || '[]');
      withdraws = JSON.parse(localStorage.getItem('withdraws') || '[]');
      if(currentUser){
        const u = users.find(x => x.username === currentUser.username);
        if(u) currentUser = u;
        updateProfileUI();
      }
    }
  });

  // initial load
  function init(){
    users = JSON.parse(localStorage.getItem('users') || '[]');
    withdraws = JSON.parse(localStorage.getItem('withdraws') || '[]');
    currentUser = null;
    // ensure every user has transactions array
    users.forEach(u => { if(!u.transactions) u.transactions = []; });
    saveAll();
    updateProfileUI();
    show('login');
  }

  init();

})();
</script>
</body>
</html>
